<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StaySwap</title>

    <!-- Styles -->
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/notification.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase / Auth ê³µí†µ -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- ê¸°ë³¸ ì„¤ì • -->
    <script>
        // ë Œë”ë§ ì‹œì  ì¶”ì  (ê°œë°œìš©)
        window.renderingDebug = {
            startTime: performance.now(),
            events: []
        };
        
        function logRenderEvent(event, data = {}) {
            const timestamp = performance.now() - window.renderingDebug.startTime;
            const logData = { event, timestamp: timestamp.toFixed(2), ...data };
            window.renderingDebug.events.push(logData);
        }
        
        logRenderEvent('HEAD_SCRIPT_START');
        
        // auth ê°ì²´ ë¯¸ë¦¬ ì´ˆê¸°í™” (auth-common.jsê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
        window.auth = window.auth || {
            isInitialized: false
        };
        
        // FCM ë””ë²„ê¹… ê°ì²´ ì¶”ê°€
        window.fcmDebug = {
            firebaseInitialized: false,
            scriptLoaded: false,
            initialized: false,
            errors: []
        };
        
        logRenderEvent('HEAD_SCRIPT_END');
    </script>
</head>

<body>
<header class="header" th:fragment="header">
    <div class="container">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-home"></i><span>StaySwap</span>
            </a>

            <nav class="main-nav">
                <a href="/page/listings" class="nav-link">ìˆ™ì†Œ ì°¾ê¸°</a>
                <a href="/page/new"       class="nav-link">ìˆ™ì†Œ ë“±ë¡</a>
                <a href="/page/exchanges" class="nav-link">êµí™˜ ê´€ë¦¬</a>
            </nav>

            <div class="user-actions">
                <!-- í”„ë¡œí•„ / ë“œë¡­ë‹¤ìš´ -->
                <div id="user-profile" class="user-profile-container">
                    <div class="profile-dropdown-container">
                        <a href="#" class="avatar-link" id="profile-dropdown-toggle">
                            <div class="avatar">
                                <img id="profile-image" src="/images/profile.png" alt="í”„ë¡œí•„" />
                            </div>
                        </a>

                        <div id="profile-dropdown" class="profile-dropdown">
                            <a href="/page/profile" class="dropdown-item">ë§ˆì´í˜ì´ì§€</a>
                            <a href="/page/subscription" class="dropdown-item">êµ¬ë…ê´€ë¦¬</a>
                            <a href="/page/messages" class="dropdown-item">ë©”ì‹œì§€</a>
                            <a href="#" id="logout-btn" class="dropdown-item">ë¡œê·¸ì•„ì›ƒ</a>
                        </div>
                    </div>
                </div>
                
                <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
                <div id="notification-icon" class="notification-container">
                    <a href="#" id="notification-dropdown-toggle" class="notification-icon-link">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge dot-only" style="display:none;"></span>
                    </a>

                    <div id="notification-dropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <span>ì•Œë¦¼</span>
                        </div>
                        <div class="notification-list">
                            <!-- ì•Œë¦¼ ëª©ë¡ì´ JavaScriptë¡œ ë™ì  ë¡œë“œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <div id="auth-buttons">
                    <a href="/page/auth" class="btn btn-outline">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </div>
</header>

<main><!-- í˜ì´ì§€ë³„ ë‚´ìš© --></main>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

<!-- Firebase SDK ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
<script>
    // Firebase SDK ë¡œë”©ì„ í™•ì¸í•˜ëŠ” í•¨ìˆ˜
    function checkFirebaseSDK() {
        if (typeof firebase !== 'undefined') {
            try {
                const testApp = firebase.apps[0];
            } catch (e) {
                // Firebase ì•± ìƒíƒœ í™•ì¸ ì‹¤íŒ¨
            }
        }
    }
    
    // ì¦‰ì‹œ ì²´í¬
    checkFirebaseSDK();
    
    // ì•½ê°„ì˜ ì§€ì—° í›„ ë‹¤ì‹œ ì²´í¬ (SDK ë¡œë”© ì™„ë£Œ ëŒ€ê¸°)
    setTimeout(checkFirebaseSDK, 500);
    setTimeout(checkFirebaseSDK, 1000);
    setTimeout(checkFirebaseSDK, 2000);
</script>

<!-- Firebase ì„¤ì • -->
<script th:inline="javascript">
    try {
        const firebaseConfig = {
            apiKey:          /*[[${firebaseConfig.apiKey}]]*/ '',
            authDomain:      /*[[${firebaseConfig.authDomain}]]*/ '',
            projectId:       /*[[${firebaseConfig.projectId}]]*/ '',
            storageBucket:   /*[[${firebaseConfig.storageBucket}]]*/ '',
            messagingSenderId: /*[[${firebaseConfig.messagingSenderId}]]*/ '',
            appId:           /*[[${firebaseConfig.appId}]]*/ '',
            measurementId:   /*[[${firebaseConfig.measurementId}]]*/ ''
        };
        
        // ì „ì—­ìœ¼ë¡œ ì €ì¥í•˜ì—¬ ë™ì  ë¡œë”©ì—ì„œ ì‚¬ìš©
        window.firebaseConfig = firebaseConfig;
        
        // ì„¤ì • ê°’ ê²€ì¦
        const missingValues = Object.entries(firebaseConfig)
            .filter(([key, value]) => !value || value === '')
            .map(([key]) => key);
        
        if (missingValues.length > 0) {
            console.error('âš ï¸ Firebase ì„¤ì •ì— ë¹ˆ ê°’ì´ ìˆìŠµë‹ˆë‹¤:', missingValues.join(', '));
            window.fcmDebug.errors.push('Firebase ì„¤ì •ì— ë¹ˆ ê°’ ìˆìŒ: ' + missingValues.join(', '));
        }
        
        // VAPID í‚¤ë¥¼ ì¦‰ì‹œ ì„¤ì •
        window.vapidKey = /*[[${firebaseConfig.vapidKey}]]*/ '';
        
        // Firebase ì´ˆê¸°í™”ëŠ” ë‚˜ì¤‘ì— setupFirebaseMessagingì—ì„œ ìˆ˜í–‰
        // (ì´ˆê¸°í™” íƒ€ì´ë° ì¶©ëŒ ë°©ì§€)
        window.fcmDebug.configReady = true;
    } catch (error) {
        console.error('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        window.fcmDebug.errors.push('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
    }
</script>

<!-- Auth ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“  í˜ì´ì§€ì—ì„œ í•„ìš”) -->
<script th:src="@{/js/auth-common.js}"></script>
<script th:src="@{/js/main.js}"></script>

<!-- í—¤ë” UI ì œì–´ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // í—¤ë” UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€)
    if (!window.headerUIInitialized) {
        window.headerUIInitialized = true;

        /* â‘  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒì— ë”°ë¼ ë²„íŠ¼ë§Œ í† ê¸€ */
        window.toggleHeaderUI = function(isLoggedIn) {
            const userProfile = document.getElementById('user-profile');
            const authButtons = document.getElementById('auth-buttons');
            const notificationIcon = document.getElementById('notification-icon');
            
            if (isLoggedIn) {
                if (userProfile) {
                    userProfile.style.display = 'block';
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'block';
                }
                if (authButtons) {
                    authButtons.style.display = 'none';
                }
            } else {
                if (userProfile) {
                    userProfile.style.display = 'none';
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'none';
                }
                if (authButtons) {
                    authButtons.style.display = 'flex';
                }
            }
        };

        /* â‘¡ ì•„ë°”íƒ€ ì´ë¯¸ì§€Â·ì´ë‹ˆì…œ ì„¸íŒ… */
        window.fillProfile = function(user) {
            if (!user) return;
            
            const img = document.getElementById('profile-image');
            const init = document.getElementById('profile-initial'); // ì´ë‹ˆì…œ í‘œì‹œë¥¼ ìœ„í•œ ìš”ì†Œ (í˜„ì¬ HTMLì— ì—†ìŒ)
            const userProfile = document.getElementById('user-profile');

            // í”„ë¡œí•„ ì»¨í…Œì´ë„ˆì— ë¡œë”© í´ë˜ìŠ¤ ì¶”ê°€
            if (userProfile) {
                userProfile.classList.add('loading');
            }

            if (user.profile && user.profile !== '/images/profile.png') {
                // ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ
                const newImg = new Image();
                newImg.onload = function() {
                    if (img) {
                        // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•´ opacity ì¡°ì‘
                        img.style.opacity = '0.7';
                        setTimeout(() => {
                            img.src = user.profile;
                            img.style.display = 'block';
                            img.style.opacity = '1';
                        }, 100);
                    }
                    if (init) init.style.display = 'none';
                    
                    // ë¡œë”© ìƒíƒœ ì œê±°
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.onerror = function() {
                    console.warn('ğŸ” í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.src = user.profile;
            } else {
                // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ ì´ë¯¸ì§€ì¸ ê²½ìš°
                if (img) {
                    img.style.display = 'block'; // ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                }
                if (init && user.name) {
                    init.style.display = 'block';
                    init.textContent = user.name.charAt(0);
                }
                
                // ë¡œë”© ìƒíƒœ ì œê±°
                if (userProfile) {
                    userProfile.classList.remove('loading');
                }
            }
        };

        /* â‘¢ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ */
        window.fetchUserInfo = async function() {
            // ë¡œê·¸ì¸ ìƒíƒœëŠ” window.isLoggedIn()ì„ í†µí•´ í™•ì¸
            const isUserLoggedIn = window.isLoggedIn();
            
            if (isUserLoggedIn) {
                window.toggleHeaderUI(true);
                try {
                    // fetchWithAuth í•¨ìˆ˜ ì‚¬ìš© (auth-common.jsì—ì„œ ì œê³µ)
                    const r = await window.fetchWithAuth('/api/user/me');
                    
                    if (r && r.ok) {
                        const userData = await r.json();
                        window.fillProfile(userData.data || userData);
                    } else {
                        console.warn('ğŸ” fetchUserInfo - ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ - API ì‘ë‹µ ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ', r?.status, ')');
                    }
                } catch (error) { 
                    console.warn('ğŸ” fetchUserInfo - ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ (ì˜ˆì™¸ ë°œìƒ):', error);
                }
                return;
            }
            window.toggleHeaderUI(false);
        };

        /* â‘¡ ì•„ë°”íƒ€ ì´ë¯¸ì§€Â·ì´ë‹ˆì…œ ì„¸íŒ… */
        window.fillProfile = function(user) {
            if (!user) {
                console.warn('ğŸ” fillProfile: ì‚¬ìš©ì ë°ì´í„°ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            const img = document.getElementById('profile-image');
            const init = document.getElementById('profile-initial'); // ì´ë‹ˆì…œ í‘œì‹œë¥¼ ìœ„í•œ ìš”ì†Œ (í˜„ì¬ HTMLì— ì—†ìŒ)
            const userProfile = document.getElementById('user-profile');

            // í”„ë¡œí•„ ì»¨í…Œì´ë„ˆì— ë¡œë”© í´ë˜ìŠ¤ ì¶”ê°€
            if (userProfile) {
                userProfile.classList.add('loading');
            }

            if (user.profile && user.profile !== '/images/profile.png') {
                // ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ
                const newImg = new Image();
                newImg.onload = function() {
                    if (img) {
                        // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•´ opacity ì¡°ì‘
                        img.style.opacity = '0.7';
                        setTimeout(() => {
                            img.src = user.profile;
                            img.style.display = 'block';
                            img.style.opacity = '1';
                        }, 100);
                    }
                    if (init) init.style.display = 'none';
                    
                    // ë¡œë”© ìƒíƒœ ì œê±°
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.onerror = function() {
                    console.warn('ğŸ” fillProfile: í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.src = user.profile;
            } else {
                // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ ì´ë¯¸ì§€ì¸ ê²½ìš°
                if (img) {
                    img.style.display = 'block'; // ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                }
                if (init && user.name) {
                    init.style.display = 'block';
                    init.textContent = user.name.charAt(0);
                }
                
                // ë¡œë”© ìƒíƒœ ì œê±°
                if (userProfile) {
                    userProfile.classList.remove('loading');
                }
            }
        };

        /* â‘£ auth ìƒíƒœ ì´ë²¤íŠ¸ â†’ í—¤ë” ë™ê¸°í™” */
        document.addEventListener('authStateChanged', function(e) {
            if (e.detail.isLoggedIn) {
                window.fetchUserInfo();
            } else {
                window.toggleHeaderUI(false);
            }
        });

        /* â‘¤ í˜ì´ì§€ ë¡œë“œ ì‹œ í—¤ë” ë™ê¸°í™” - authStateChanged ì´ë²¤íŠ¸ì—ë§Œ ì˜ì¡´ */
        // auth-common.jsì—ì„œ ë°œìƒì‹œí‚¤ëŠ” authStateChanged ì´ë²¤íŠ¸ì—ë§Œ ì˜ì¡´í•˜ë„ë¡ ë³€ê²½
        // ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€
    }
</script>

</body>
</html>
