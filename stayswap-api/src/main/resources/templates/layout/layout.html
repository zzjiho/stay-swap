<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StaySwap</title>

    <!-- Styles -->
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/notification.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase / Auth ê³µí†µ -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- ğŸ” ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë¡œê·¸ -->
    <script>
        console.log('ğŸ” TEST 1: HTML HEADì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨');
        
        // auth ê°ì²´ ë¯¸ë¦¬ ì´ˆê¸°í™” (auth-common.jsê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
        window.auth = window.auth || {
            accessToken: null,
            tokenExpireTime: null,
            isInitialized: false
        };
        
        // FCM ë””ë²„ê¹… ê°ì²´ ì¶”ê°€
        window.fcmDebug = {
            firebaseInitialized: false,
            scriptLoaded: false,
            initialized: false,
            errors: []
        };
        
        // ì´ì „ ë¡œê·¸ì¸ ìƒíƒœë¥¼ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í™•ì¸í•˜ì—¬ ì´ˆê¸° UI ì„¤ì •
        const lastLoginState = localStorage.getItem('stayswap_last_login_state');
        
        // í˜ì´ì§€ ë¡œë“œ ì¦‰ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì • (ê¹œë¹¡ì„ ìµœì†Œí™”)
        function setInitialUIState() {
            const userProfile = document.getElementById('user-profile');
            const notificationIcon = document.getElementById('notification-icon');
            const authButtons = document.getElementById('auth-buttons');
            
            if (lastLoginState === 'true') {
                // ì´ì „ì— ë¡œê·¸ì¸ ìƒíƒœì˜€ë‹¤ë©´ ë¯¸ë¦¬ ë¡œê·¸ì¸ UI í‘œì‹œ
                if (userProfile) userProfile.style.display = 'block';
                if (notificationIcon) notificationIcon.style.display = 'block';
                if (authButtons) authButtons.style.display = 'none';
                console.log('ğŸ” ì´ì „ ë¡œê·¸ì¸ ìƒíƒœ ê¸°ë°˜ìœ¼ë¡œ UI ë¯¸ë¦¬ ì„¤ì •ë¨');
            } else {
                // ì´ì „ì— ë¡œê·¸ì•„ì›ƒ ìƒíƒœì˜€ë‹¤ë©´ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ
                if (authButtons) authButtons.style.display = 'flex';
                console.log('ğŸ” ì´ì „ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ê¸°ë°˜ìœ¼ë¡œ UI ë¯¸ë¦¬ ì„¤ì •ë¨');
            }
        }
        
        // DOMì´ ì¤€ë¹„ë˜ë©´ ì¦‰ì‹œ ì„¤ì •
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setInitialUIState);
        } else {
            setInitialUIState();
        }
        
        console.log('ğŸ” TEST 2: Layout script loaded: auth and fcmDebug objects initialized');
    </script>
</head>

<body>
<header class="header" th:fragment="header">
    <div class="container">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-home"></i><span>StaySwap</span>
            </a>

            <nav class="main-nav">
                <a href="/page/listings" class="nav-link">ìˆ™ì†Œ ì°¾ê¸°</a>
                <a href="/page/new"       class="nav-link">ìˆ™ì†Œ ë“±ë¡</a>
                <a href="/page/exchanges" class="nav-link">êµí™˜ ê´€ë¦¬</a>
            </nav>

            <div class="user-actions">
                <!-- í”„ë¡œí•„ / ë“œë¡­ë‹¤ìš´ -->
                <div id="user-profile" class="user-profile-container" style="display:none;">
                    <div class="profile-dropdown-container">
                        <a href="#" class="avatar-link" id="profile-dropdown-toggle">
                            <div class="avatar">
                                <img id="profile-image" src="/images/profile.png" alt="í”„ë¡œí•„" />
<!--                                <span id="profile-initial">ì‚¬</span>-->
                            </div>
                        </a>

                        <div id="profile-dropdown" class="profile-dropdown">
                            <a href="/page/profile"      class="dropdown-item">ë§ˆì´í˜ì´ì§€</a>
                            <a href="/page/subscription" class="dropdown-item">êµ¬ë…ê´€ë¦¬</a>
                            <a href="#" id="logout-btn"  class="dropdown-item">ë¡œê·¸ì•„ì›ƒ</a>
                        </div>
                    </div>
                </div>
                
                <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
                <div id="notification-icon" class="notification-container" style="display:none;">
                    <a href="#" id="notification-dropdown-toggle" class="notification-icon-link">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge dot-only" style="display:none;"></span>
                    </a>

                    <div id="notification-dropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <span>ì•Œë¦¼</span>
                        </div>
                        <div class="notification-list">
                            <!-- ì•Œë¦¼ ëª©ë¡ì´ JavaScriptë¡œ ë™ì  ë¡œë“œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <div id="auth-buttons" style="display:flex;">
                    <a href="/page/auth" class="btn btn-outline">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </div>
</header>

<main><!-- í˜ì´ì§€ë³„ ë‚´ìš© --></main>

<!-- ğŸ” ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë¡œê·¸ 2 -->
<script>
    console.log('ğŸ” TEST 3: BODY ì‹œì‘ ë¶€ë¶„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨');
</script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

<!-- ğŸ” jQuery ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 4: jQuery ë¡œë“œ í›„, jQuery ë²„ì „:', $ ? $.fn.jquery : 'jQuery ì—†ìŒ');
</script>

<!-- Firebase ì„¤ì • -->
<script th:inline="javascript">
    console.log('ğŸ” TEST 5: Firebase ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘');
    try {
        const firebaseConfig = {
            apiKey:          /*[[${firebaseConfig.apiKey}]]*/ '',
            authDomain:      /*[[${firebaseConfig.authDomain}]]*/ '',
            projectId:       /*[[${firebaseConfig.projectId}]]*/ '',
            storageBucket:   /*[[${firebaseConfig.storageBucket}]]*/ '',
            messagingSenderId: /*[[${firebaseConfig.messagingSenderId}]]*/ '',
            appId:           /*[[${firebaseConfig.appId}]]*/ '',
            measurementId:   /*[[${firebaseConfig.measurementId}]]*/ ''
        };
        
        console.log('ğŸ” TEST 6: Firebase ì„¤ì • ê°ì²´ ìƒì„±ë¨:', firebaseConfig);
        
        // ì„¤ì • ê°’ ê²€ì¦
        const missingValues = Object.entries(firebaseConfig)
            .filter(([key, value]) => !value || value === '')
            .map(([key]) => key);
        
        if (missingValues.length > 0) {
            console.error('âš ï¸ Firebase ì„¤ì •ì— ë¹ˆ ê°’ì´ ìˆìŠµë‹ˆë‹¤:', missingValues.join(', '));
            window.fcmDebug.errors.push('Firebase ì„¤ì •ì— ë¹ˆ ê°’ ìˆìŒ: ' + missingValues.join(', '));
        } else {
            console.log('âœ… Firebase ì„¤ì • ê°’ í™•ì¸ë¨');
        }
        
        // Firebase ì´ˆê¸°í™”
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.vapidKey = /*[[${firebaseConfig.vapidKey}]]*/ '';
            window.fcmDebug.firebaseInitialized = true;
            console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.error('âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            window.fcmDebug.errors.push('Firebase SDK ë¡œë“œë˜ì§€ ì•ŠìŒ');
        }
    } catch (error) {
        console.error('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        window.fcmDebug.errors.push('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
    }
</script>

<!-- ğŸ” ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 7: ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ ì „');
</script>

<!-- Auth ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“  í˜ì´ì§€ì—ì„œ í•„ìš”) -->
<script th:src="@{/js/auth-common.js}"></script>
<script th:src="@{/js/main.js}"></script>

<!-- ğŸ” ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í›„ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 8: ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í›„');
    console.log('ğŸ” window.auth ìƒíƒœ:', window.auth);
    console.log('ğŸ” window.isLoggedIn í•¨ìˆ˜ ì¡´ì¬:', typeof window.isLoggedIn);
</script>

<!-- í—¤ë” UI ì œì–´ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    console.log('ğŸ” TEST 9: Layout í—¤ë” UI ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
    
    // í—¤ë” UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€)
    if (!window.headerUIInitialized) {
        window.headerUIInitialized = true;
        console.log('ğŸ” TEST 10: í—¤ë” UI ì´ˆê¸°í™” ì‹œì‘');

        /* â‘  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒì— ë”°ë¼ ë²„íŠ¼ë§Œ í† ê¸€ */
        window.toggleHeaderUI = function(isLoggedIn) {
            console.log('ğŸ” toggleHeaderUI í˜¸ì¶œ:', isLoggedIn);
            const userProfile = document.getElementById('user-profile');
            const authButtons = document.getElementById('auth-buttons');
            const notificationIcon = document.getElementById('notification-icon');
            
            if (isLoggedIn) {
                console.log('ğŸ” ë¡œê·¸ì¸ UI í‘œì‹œ');
                if (userProfile) {
                    userProfile.style.display = 'block';
                    console.log('ğŸ” user-profile í‘œì‹œë¨');
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'block';
                    console.log('ğŸ” notification-icon í‘œì‹œë¨');
                }
                if (authButtons) {
                    authButtons.style.display = 'none';
                    console.log('ğŸ” auth-buttons ìˆ¨ê¹€');
                }
            } else {
                console.log('ğŸ” ë¡œê·¸ì•„ì›ƒ UI í‘œì‹œ');
                if (userProfile) {
                    userProfile.style.display = 'none';
                    console.log('ğŸ” user-profile ìˆ¨ê¹€');
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'none';
                    console.log('ğŸ” notification-icon ìˆ¨ê¹€');
                }
                if (authButtons) {
                    authButtons.style.display = 'flex';
                    console.log('ğŸ” auth-buttons í‘œì‹œë¨');
                }
            }
        };

        /* â‘¡ ì•„ë°”íƒ€ ì´ë¯¸ì§€Â·ì´ë‹ˆì…œ ì„¸íŒ… */
        window.fillProfile = function(user) {
            console.log('ğŸ” fillProfile í˜¸ì¶œ:', user);
            if (!user) return;
            const img  = document.getElementById('profile-image');
            const init = document.getElementById('profile-initial');

            if (user.profile) {
                if (img) {
                    img.src = user.profile;
                    img.style.display  = 'block';
                    console.log('ğŸ” í”„ë¡œí•„ ì´ë¯¸ì§€ ì„¤ì •ë¨');
                }
                if (init) init.style.display = 'none';
            } else {
                if (img) img.style.display  = 'none';
                if (init) {
                    init.style.display = 'block';
                    init.textContent   = user.name ? user.name.charAt(0) : '?';
                    console.log('ğŸ” í”„ë¡œí•„ ì´ë‹ˆì…œ ì„¤ì •ë¨');
                }
            }
        };

        /* â‘¢ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ */
        window.fetchUserInfo = async function() {
            console.log('ğŸ” fetchUserInfo í˜¸ì¶œ');
            
            // ì¸ì¦ ìƒíƒœëŠ” auth-common.jsì—ì„œ ê´€ë¦¬
            const isUserLoggedIn = (typeof window.isLoggedIn === 'function') 
                ? window.isLoggedIn() 
                : (!!window.auth?.accessToken);
            
            console.log('ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸:', isUserLoggedIn);
            
            if (isUserLoggedIn) {
                window.toggleHeaderUI(true);
                try {
                    console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ API í˜¸ì¶œ ì‹œë„');
                    // fetchWithAuth í•¨ìˆ˜ ì‚¬ìš© (auth-common.jsì—ì„œ ì œê³µ)
                    const r = (typeof window.fetchWithAuth === 'function')
                        ? await window.fetchWithAuth('/api/user/me')
                        : await fetch('/api/user/me', {
                              headers: { Authorization: `Bearer ${window.auth.accessToken}` },
                              credentials: 'include'
                          });
                    
                    if (r && r.ok) {
                        const userData = await r.json();
                        console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ:', userData);
                        window.fillProfile(userData.data || userData);
                    } else {
                        console.warn('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ - API ì‘ë‹µ ì˜¤ë¥˜');
                    }
                } catch (error) { 
                    console.warn('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                }
                return;
            }
            window.toggleHeaderUI(false);
        };

        /* â‘£ auth ìƒíƒœ ì´ë²¤íŠ¸ â†’ í—¤ë” ë™ê¸°í™” */
        document.addEventListener('authStateChanged', function(e) {
            console.log('ğŸ” Layoutì—ì„œ authStateChanged ì´ë²¤íŠ¸ ìˆ˜ì‹ :', e.detail.isLoggedIn);
            if (e.detail.isLoggedIn) {
                window.fetchUserInfo();
            } else {
                window.toggleHeaderUI(false);
            }
        });

        /* â‘¤ í˜ì´ì§€ ë¡œë“œ ì‹œ í—¤ë” ë™ê¸°í™” */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” TEST 11: Layout DOMContentLoaded - í—¤ë” ë™ê¸°í™” ì‹œì‘');
            // auth-common.js ë¡œë“œ ëŒ€ê¸° í›„ ì‹¤í–‰
            setTimeout(() => {
                console.log('ğŸ” TEST 12: ì§€ì—° í›„ fetchUserInfo í˜¸ì¶œ');
                window.fetchUserInfo();
            }, 200); // 200msë¡œ ì¦ê°€
        });

        // ì¶”ê°€: í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ì—ë„ í•œë²ˆ ë” ì²´í¬ (ë°±ì—…)
        window.addEventListener('load', function() {
            console.log('ğŸ” TEST 13: Window load ì™„ë£Œ - ì¶”ê°€ ì²´í¬');
            setTimeout(() => {
                // auth ìƒíƒœê°€ ì„¤ì •ë˜ì—ˆì§€ë§Œ UIê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
                if (window.auth?.accessToken && 
                    document.getElementById('user-profile')?.style.display === 'none') {
                    console.log('ğŸ” í† í°ì€ ìˆì§€ë§Œ UIê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ - ê°•ì œ ì—…ë°ì´íŠ¸');
                    window.fetchUserInfo();
                }
            }, 300);
        });
    } else {
        console.log('ğŸ” TEST 10-1: í—¤ë” UI ì´ë¯¸ ì´ˆê¸°í™”ë¨');
    }
</script>

<!-- ğŸ” ìµœì¢… í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 14: Layout ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
</script>

</body>
</html>
