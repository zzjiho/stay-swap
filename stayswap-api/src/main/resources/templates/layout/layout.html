<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StaySwap</title>

    <!-- Styles -->
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Firebase / Auth ê³µí†µ -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Auth ì´ˆê¸°í™” ë¯¸ë¦¬ ìƒì„± -->
    <script>
        // auth ê°ì²´ ë¯¸ë¦¬ ì´ˆê¸°í™”
        window.auth = window.auth || {
            accessToken: null,
            tokenExpireTime: null,
            isInitialized: false
        };
        
        // FCM ë””ë²„ê¹… ê°ì²´ ì¶”ê°€
        window.fcmDebug = {
            firebaseInitialized: false,
            scriptLoaded: false,
            initialized: false,
            errors: []
        };
        
        console.log('ğŸ” Layout script loaded: auth and fcmDebug objects initialized');
    </script>
    
    <!-- Auth ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ -->
    <script th:src="@{/js/auth-common.js}"></script>
</head>

<body>
<header class="header">
    <div class="container">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-home"></i><span>StaySwap</span>
            </a>

            <nav class="main-nav">
                <a href="/page/listings" class="nav-link">ìˆ™ì†Œ ì°¾ê¸°</a>
                <a href="/page/new"       class="nav-link">ìˆ™ì†Œ ë“±ë¡</a>
                <a href="/page/exchanges" class="nav-link">êµí™˜ ê´€ë¦¬</a>
            </nav>

            <div class="user-actions">
                <!-- í”„ë¡œí•„ / ë“œë¡­ë‹¤ìš´ -->
                <div id="user-profile" class="user-profile-container" style="display:none;">
                    <div class="profile-dropdown-container">
                        <a href="#" class="avatar-link" id="profile-dropdown-toggle">
                            <div class="avatar">
                                <img id="profile-image" src="/images/profile.png" alt="í”„ë¡œí•„" />
<!--                                <span id="profile-initial">ì‚¬</span>-->
                            </div>
                        </a>

                        <div id="profile-dropdown" class="profile-dropdown">
                            <a href="/page/profile"      class="dropdown-item">ë§ˆì´í˜ì´ì§€</a>
                            <a href="/page/subscription" class="dropdown-item">êµ¬ë…ê´€ë¦¬</a>
                            <a href="#" id="logout-btn"  class="dropdown-item">ë¡œê·¸ì•„ì›ƒ</a>
                        </div>
                    </div>
                </div>
                
                <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
                <div id="notification-icon" class="notification-container" style="display:none;">
                    <a href="#" id="notification-toggle" class="notification-icon-link">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge" style="display:none;"></span>
                    </a>
                </div>

                <!-- ì•Œë¦¼ íŒì˜¤ë²„ -->
                <div id="notification-popover" class="notification-popover" style="display: none;">
                    <div class="notification-popover-content">
                        <div class="notification-header">
                            <h3>ì•Œë¦¼</h3>
                            <div class="header-actions">
                                <button id="mark-all-read" class="btn-text">ëª¨ë‘ ì½ìŒ</button>
                                <button id="close-popover" class="btn-close">Ã—</button>
                            </div>
                        </div>
                        <div id="notification-popover-list" class="notification-popover-list">
                            <div class="notification-loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
                            </div>
                        </div>
                        <div class="notification-footer">
                            <a href="/notifications" class="view-all-link">ëª¨ë“  ì•Œë¦¼ ë³´ê¸°</a>
                        </div>
                    </div>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <div id="auth-buttons">
                    <a href="/page/auth" class="btn btn-outline">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </div>
</header>

<main><!-- í˜ì´ì§€ë³„ ë‚´ìš© --></main>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

<!-- Firebase ì„¤ì • -->
<script th:inline="javascript">
    console.log('ğŸ” Firebase ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘');
    try {
        const firebaseConfig = {
            apiKey:          /*[[${firebaseConfig.apiKey}]]*/ '',
            authDomain:      /*[[${firebaseConfig.authDomain}]]*/ '',
            projectId:       /*[[${firebaseConfig.projectId}]]*/ '',
            storageBucket:   /*[[${firebaseConfig.storageBucket}]]*/ '',
            messagingSenderId: /*[[${firebaseConfig.messagingSenderId}]]*/ '',
            appId:           /*[[${firebaseConfig.appId}]]*/ '',
            measurementId:   /*[[${firebaseConfig.measurementId}]]*/ ''
        };
        
        // ì„¤ì • ê°’ ê²€ì¦
        const missingValues = Object.entries(firebaseConfig)
            .filter(([key, value]) => !value || value === '')
            .map(([key]) => key);
        
        if (missingValues.length > 0) {
            console.error('âš ï¸ Firebase ì„¤ì •ì— ë¹ˆ ê°’ì´ ìˆìŠµë‹ˆë‹¤:', missingValues.join(', '));
            window.fcmDebug.errors.push('Firebase ì„¤ì •ì— ë¹ˆ ê°’ ìˆìŒ: ' + missingValues.join(', '));
        } else {
            console.log('âœ… Firebase ì„¤ì • ê°’ í™•ì¸ë¨');
        }
        
        // Firebase ì´ˆê¸°í™”
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.vapidKey = /*[[${firebaseConfig.vapidKey}]]*/ '';
            window.fcmDebug.firebaseInitialized = true;
            console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.error('âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            window.fcmDebug.errors.push('Firebase SDK ë¡œë“œë˜ì§€ ì•ŠìŒ');
        }
    } catch (error) {
        console.error('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        window.fcmDebug.errors.push('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
    }
</script>

<!-- ê¸°íƒ€ ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/fcm-token.js}"></script>
<script th:src="@{/js/notification.js}"></script>
<script th:src="@{/js/debug.js}"></script>

<!-- *** í—¤ë” UI ì œì–´ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ *** -->
<script>
    /* â‘  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒì— ë”°ë¼ ë²„íŠ¼ë§Œ í† ê¸€ */
    function toggleHeaderUI(isLoggedIn) {
        const userProfile = document.getElementById('user-profile');
        const authButtons = document.getElementById('auth-buttons');
        const notificationIcon = document.getElementById('notification-icon');
        
        if (isLoggedIn) {
            userProfile.style.display = 'block';
            notificationIcon.style.display = 'block';
            authButtons.style.display = 'none';
        } else {
            userProfile.style.display = 'none';
            notificationIcon.style.display = 'none';
            authButtons.style.display = 'flex';
        }
    }

    /* â‘¡ ì•„ë°”íƒ€ ì´ë¯¸ì§€Â·ì´ë‹ˆì…œ ì„¸íŒ… */
    function fillProfile(user) {
        if (!user) return;
        const img  = document.getElementById('profile-image');
        const init = document.getElementById('profile-initial');

        if (user.profile) {
            img.src = user.profile;
            img.style.display  = 'block';
            init.style.display = 'none';
        } else {
            img.style.display  = 'none';
            init.style.display = 'block';
            init.textContent   = user.name ? user.name.charAt(0) : '?';
        }
    }

    /* â‘¢ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ */
    async function fetchUserInfo() {
        // isLoggedIn í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì§ì ‘ í™•ì¸
        const isUserLoggedIn = (typeof isLoggedIn === 'function') 
            ? isLoggedIn() 
            : (!!window.auth?.accessToken);
        
        if (isUserLoggedIn) {
            toggleHeaderUI(true);          // accessTokenë§Œ ìˆì–´ë„ ë°”ë¡œ ë¡œê·¸ì¸ UI
            try {
                // fetchWithAuth í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ì§ì ‘ êµ¬í˜„
                const r = (typeof fetchWithAuth === 'function')
                    ? await fetchWithAuth('/api/user/me')
                    : await fetch('/api/user/me', {
                          headers: { Authorization: `Bearer ${window.auth.accessToken}` },
                          credentials: 'include'
                      });
                
                if (r && r.ok) fillProfile(await r.json());
            } catch (error) { 
                /* ì‹¤íŒ¨í•´ë„ ìƒê´€ì—†ìŒ */ 
            }
            return;
        }
        toggleHeaderUI(false);             // í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ ë²„íŠ¼
    }

    /* â‘£ auth ìƒíƒœ ì´ë²¤íŠ¸ â†’ í—¤ë” ë™ê¸°í™” */
    document.addEventListener('authStateChanged', e => {
        e.detail.isLoggedIn ? fetchUserInfo() : toggleHeaderUI(false);
    });

    /* â‘¤ í˜ì´ì§€ ë¡œë“œ â†’ í—¤ë” ë™ê¸°í™” */
    document.addEventListener('DOMContentLoaded', fetchUserInfo);

    /* â‘¥ ì•„ë°”íƒ€ í´ë¦­ â†’ ë“œë¡­ë‹¤ìš´ í† ê¸€ */
    document.addEventListener('DOMContentLoaded', () => {
        const toggle   = document.getElementById('profile-dropdown-toggle');
        const dropdown = document.getElementById('profile-dropdown');
        if (!toggle) return;

        toggle.addEventListener('click', e => {
            e.preventDefault();
            dropdown.classList.toggle('active');
            // ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
            document.getElementById('notification-dropdown').classList.remove('active');
        });
        document.addEventListener('click', e => {
            if (!toggle.contains(e.target) && !dropdown.contains(e.target))
                dropdown.classList.remove('active');
        });
    });
    
    /* â‘¦ ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ â†’ ì•Œë¦¼ íŒì˜¤ë²„ í† ê¸€ */
    document.addEventListener('DOMContentLoaded', () => {
        const notificationToggle = document.getElementById('notification-toggle');
        const notificationPopover = document.getElementById('notification-popover');
        const closePopoverBtn = document.getElementById('close-popover');
        const markAllReadBtn = document.getElementById('mark-all-read');
        
        if (!notificationToggle || !notificationPopover) return;

        // ì•Œë¦¼ ì•„ì´ì½˜ í´ë¦­ ì‹œ íŒì˜¤ë²„ ì—´ê¸°
        notificationToggle.addEventListener('click', e => {
            e.preventDefault();
            e.stopPropagation();
            openNotificationPopover();
        });

        // íŒì˜¤ë²„ ë‹«ê¸° ë²„íŠ¼
        closePopoverBtn.addEventListener('click', e => {
            e.preventDefault();
            closeNotificationPopover();
        });

        // íŒì˜¤ë²„ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        notificationPopover.addEventListener('click', e => {
            if (e.target === notificationPopover) {
                closeNotificationPopover();
            }
        });

        // ESC í‚¤ë¡œ íŒì˜¤ë²„ ë‹«ê¸°
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape' && notificationPopover.style.display === 'flex') {
                closeNotificationPopover();
            }
        });

        // ëª¨ë‘ ì½ìŒ í‘œì‹œ
        markAllReadBtn.addEventListener('click', e => {
            e.preventDefault();
            markAllNotificationsAsRead();
        });
    });
</script>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì¶”ê°€ í™•ì¸ (ë°±ì—…)
    document.addEventListener('DOMContentLoaded', () => {
        /* accessToken ìˆìœ¼ë©´ â†’ ë¡œê·¸ì¸ ìƒíƒœë¡œ ê°„ì£¼ */
        if (window.auth?.accessToken) {
            toggleHeaderUI(true);
        } else {
            // ë¦¬í”„ë ˆì‹œ í† í° ì¿ í‚¤ í™•ì¸ í•¨ìˆ˜
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }
            
            // ë¦¬í”„ë ˆì‹œ í† í°ì´ ìˆì„ ë•Œ ìˆ˜ë™ìœ¼ë¡œ ê°±ì‹  ì‹œë„
            const refreshToken = getCookie('refreshToken');
            if (refreshToken) {
                if (typeof initializeAuth === 'function') {
                    setTimeout(async () => {
                        try {
                            const success = await initializeAuth();
                            if (success) {
                                toggleHeaderUI(true);
                            }
                        } catch (error) {
                            // ì˜¤ë¥˜ ì²˜ë¦¬
                        }
                    }, 500);
                } else {
                    setTimeout(async () => {
                        try {
                            const r = await fetch('/api/token/refresh', {
                                method: 'GET',
                                credentials: 'include'
                            });
                            
                            if (r.ok) {
                                const data = await r.json();
                                
                                window.auth.accessToken = data.accessToken;
                                window.auth.tokenExpireTime = new Date(data.accessTokenExpireTime).getTime();
                                window.auth.isInitialized = true;
                                
                                toggleHeaderUI(true);
                                
                                // ì¸ì¦ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ë°œìƒ
                                document.dispatchEvent(new CustomEvent('authStateChanged', {
                                    detail: { isLoggedIn: true }
                                }));
                            }
                        } catch (error) {
                            // ì˜¤ë¥˜ ì²˜ë¦¬
                        }
                    }, 500);
                }
            }
        }
    });
</script>

<!-- ì•Œë¦¼ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    // í—¤ë” ë°°ì§€ìš© ì•Œë¦¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë°±ê·¸ë¼ìš´ë“œ)
    async function fetchNotifications() {
        try {
            if (!window.auth?.accessToken) return;
            
            const response = await fetch('/api/notifications?page=0&size=5', {
                headers: { 
                    'Authorization': `Bearer ${window.auth.accessToken}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            if (response.ok) {
                const data = await response.json();
                const notifications = data.content || data;
                updateNotificationBadge(notifications);
            }
        } catch (error) {
            console.error('ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
        }
    }
    
    // íŒì˜¤ë²„ ì—´ê¸°
    function openNotificationPopover() {
        const popover = document.getElementById('notification-popover');
        popover.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // ë°°ê²½ ìŠ¤í¬ë¡¤ ë°©ì§€
        
        // ì•Œë¦¼ ë°ì´í„° ë¡œë“œ
        loadNotificationsForPopover();
    }

    // íŒì˜¤ë²„ ë‹«ê¸°
    function closeNotificationPopover() {
        const popover = document.getElementById('notification-popover');
        popover.style.display = 'none';
        document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
    }

    // íŒì˜¤ë²„ìš© ì•Œë¦¼ ë°ì´í„° ë¡œë“œ
    async function loadNotificationsForPopover() {
        const notificationList = document.getElementById('notification-popover-list');
        
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        notificationList.innerHTML = `
            <div class="notification-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <span>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>
        `;

        try {
            if (!window.auth?.accessToken) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-sign-in-alt"></i>
                        <h4>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h4>
                        <p>ì•Œë¦¼ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }

            const response = await fetch('/api/notifications?page=0&size=10', {
                headers: {
                    'Authorization': `Bearer ${window.auth.accessToken}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();
            const notifications = data.content || data;
            
            renderNotificationsInPopover(notifications);
            updateNotificationBadge(notifications);

        } catch (error) {
            console.error('ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
            notificationList.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h4>ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                </div>
            `;
        }
    }

    // íŒì˜¤ë²„ì— ì•Œë¦¼ ë Œë”ë§
    function renderNotificationsInPopover(notifications) {
        const notificationList = document.getElementById('notification-popover-list');
        
        if (!notifications || notifications.length === 0) {
            notificationList.innerHTML = `
                <div class="notification-empty">
                    <i class="fas fa-bell-slash"></i>
                    <h4>ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì˜¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            `;
            return;
        }

        notificationList.innerHTML = '';
        notifications.forEach(notification => {
            const notificationItem = createNotificationPopoverItem(notification);
            notificationList.appendChild(notificationItem);
        });
    }

    // íŒì˜¤ë²„ìš© ì•Œë¦¼ ì•„ì´í…œ ìƒì„±
    function createNotificationPopoverItem(notification) {
        const notificationItem = document.createElement('div');
        notificationItem.className = `notification-item ${notification.read ? '' : 'unread'}`;
        notificationItem.dataset.id = notification.id;
        
        // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜ ì„¤ì •
        const typeIcon = getNotificationTypeIcon(notification.type);
        
        // í”„ë¡œí•„ ì´ë¯¸ì§€ ë˜ëŠ” ì´ë‹ˆì…œ
        const avatarContent = notification.senderProfileImage 
            ? `<img src="${notification.senderProfileImage}" alt="${notification.senderName}" />`
            : `<div class="avatar-placeholder">${notification.senderName ? notification.senderName.charAt(0) : '?'}</div>`;

        notificationItem.innerHTML = `
            <div class="notification-avatar">
                ${avatarContent}
                <div class="notification-type-icon ${typeIcon.class}">
                    <i class="fas ${typeIcon.icon}"></i>
                </div>
            </div>
            <div class="notification-content">
                <div class="notification-header-info">
                    <span class="notification-username">${notification.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                    <span class="notification-time">${formatTimeAgo(notification.createdAt)}</span>
                </div>
                <div class="notification-message">${notification.message}</div>
            </div>
        `;
        
        // ì•Œë¦¼ í´ë¦­ ì´ë²¤íŠ¸
        notificationItem.addEventListener('click', () => {
            markNotificationAsRead(notification.id);
            closeNotificationPopover(); // íŒì˜¤ë²„ ë‹«ê¸°
            if (notification.actionUrl) {
                window.location.href = notification.actionUrl;
            }
        });
        
        return notificationItem;
    }

    // ì•Œë¦¼ íƒ€ì…ë³„ ì•„ì´ì½˜ ë°˜í™˜
    function getNotificationTypeIcon(type) {
        switch (type) {
            case 'LIKE':
                return { icon: 'fa-heart', class: 'like' };
            case 'BOOKING_REQUEST':
            case 'BOOKING_CONFIRMED':
            case 'BOOKING_CANCELLED':
                return { icon: 'fa-calendar', class: 'booking' };
            case 'SWAP_REQUEST':
            case 'SWAP_ACCEPTED':
            case 'SWAP_REJECTED':
                return { icon: 'fa-exchange-alt', class: 'swap' };
            case 'MESSAGE':
                return { icon: 'fa-envelope', class: 'message' };
            default:
                return { icon: 'fa-bell', class: 'message' };
        }
    }
    
    // ì•Œë¦¼ ë°°ì§€ ì—…ë°ì´íŠ¸ (ë¹¨ê°„ì ë§Œ í‘œì‹œ)
    function updateNotificationBadge(notifications) {
        const badge = document.getElementById('notification-badge');
        const unreadCount = notifications ? notifications.filter(n => !n.read).length : 0;
        
        if (unreadCount > 0) {
            badge.style.display = 'block';
        } else {
            badge.style.display = 'none';
        }
    }
    
    // ì•Œë¦¼ ì½ìŒ í‘œì‹œ
    async function markNotificationAsRead(notificationId) {
        try {
            if (!window.auth?.accessToken) return;
            
            await fetch(`/api/notifications/${notificationId}/read`, {
                method: 'PUT',
                headers: { 
                    'Authorization': `Bearer ${window.auth.accessToken}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            // UI ì—…ë°ì´íŠ¸
            const notificationItem = document.querySelector(`.notification-item[data-id="${notificationId}"]`);
            if (notificationItem) {
                notificationItem.classList.remove('unread');
            }
            
            // ë°°ì§€ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì•Œë¦¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
            fetchNotifications();
        } catch (error) {
            console.error('ì•Œë¦¼ ì½ìŒ í‘œì‹œ ì‹¤íŒ¨:', error);
        }
    }
    
    // ëª¨ë“  ì•Œë¦¼ ì½ìŒ í‘œì‹œ
    async function markAllNotificationsAsRead() {
        try {
            if (!window.auth?.accessToken) return;
            
            await fetch('/api/notifications/read-all', {
                method: 'PUT',
                headers: { 
                    'Authorization': `Bearer ${window.auth.accessToken}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            
            // íŒì˜¤ë²„ê°€ ì—´ë ¤ìˆìœ¼ë©´ ë‹¤ì‹œ ë¡œë“œ
            const popover = document.getElementById('notification-popover');
            if (popover && popover.style.display === 'flex') {
                loadNotificationsForPopover();
            }
            
            // ë°°ì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('notification-badge').style.display = 'none';
        } catch (error) {
            console.error('ëª¨ë“  ì•Œë¦¼ ì½ìŒ í‘œì‹œ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì•Œë¦¼ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updateNotificationsReadStatus() {
        try {
            if (!window.auth?.accessToken) return;
            
            // í˜„ì¬ ë³´ì´ëŠ” ì•Œë¦¼ë“¤ë§Œ ì½ìŒ í‘œì‹œ
            const visibleNotifications = document.querySelectorAll('.notification-item.unread');
            for (const item of visibleNotifications) {
                await markNotificationAsRead(item.dataset.id);
            }
        } catch (error) {
            console.error('ì•Œë¦¼ ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì‹œê°„ í˜•ì‹í™” (ì˜ˆ: "3ì‹œê°„ ì „")
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffDay > 0) {
            return `${diffDay}ì¼ ì „`;
        } else if (diffHour > 0) {
            return `${diffHour}ì‹œê°„ ì „`;
        } else if (diffMin > 0) {
            return `${diffMin}ë¶„ ì „`;
        } else {
            return 'ë°©ê¸ˆ ì „';
        }
    }
    
    // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ì‹œ ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('authStateChanged', e => {
        if (e.detail.isLoggedIn) {
            fetchNotifications();
            // ì£¼ê¸°ì ìœ¼ë¡œ ì•Œë¦¼ ì—…ë°ì´íŠ¸ (1ë¶„ë§ˆë‹¤)
            setInterval(fetchNotifications, 60000);
        }
    });
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê°€ì ¸ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', () => {
        if (window.auth?.accessToken) {
            fetchNotifications();
        }
    });
</script>


</body>
</html>
