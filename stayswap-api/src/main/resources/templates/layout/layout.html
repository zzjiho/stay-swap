<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StaySwap</title>

    <!-- Styles -->
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/notification.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase / Auth ê³µí†µ -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- ğŸ” ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë¡œê·¸ -->
    <script>
        console.log('ğŸ” TEST 1: HTML HEADì—ì„œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨');
        
        // ë Œë”ë§ ì‹œì  ì¶”ì 
        window.renderingDebug = {
            startTime: performance.now(),
            events: []
        };
        
        function logRenderEvent(event, data = {}) {
            const timestamp = performance.now() - window.renderingDebug.startTime;
            const logData = { event, timestamp: timestamp.toFixed(2), ...data };
            window.renderingDebug.events.push(logData);
            console.log(`ğŸ” [${timestamp.toFixed(2)}ms] ${event}:`, data);
        }
        
        logRenderEvent('HEAD_SCRIPT_START');
        
        // auth ê°ì²´ ë¯¸ë¦¬ ì´ˆê¸°í™” (auth-common.jsê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„)
        window.auth = window.auth || {
            accessToken: null,
            tokenExpireTime: null,
            isInitialized: false
        };
        
        // FCM ë””ë²„ê¹… ê°ì²´ ì¶”ê°€
        window.fcmDebug = {
            firebaseInitialized: false,
            scriptLoaded: false,
            initialized: false,
            errors: []
        };
        
        // ì¦‰ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸í•˜ì—¬ body í´ë˜ìŠ¤ ì„¤ì •
        (function setInitialAuthClass() {
            const token = localStorage.getItem('access_token');
            const expireTime = localStorage.getItem('token_expire_time');
            const now = new Date().getTime();
            const isLoggedIn = !!(token && expireTime && now < parseInt(expireTime));
            
            logRenderEvent('TOKEN_CHECK', {
                hasToken: !!token,
                isExpired: expireTime ? now > parseInt(expireTime) : true,
                isLoggedIn: isLoggedIn
            });
            
            // ì¦‰ì‹œ body í´ë˜ìŠ¤ ì„¤ì • (DOM ë¡œë“œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
            const targetClass = isLoggedIn ? 'auth-logged-in' : 'auth-logged-out';
            
            // bodyê°€ ì•„ì§ ì—†ìœ¼ë©´ HTMLì— í´ë˜ìŠ¤ ì¶”ê°€
            if (!document.body) {
                document.documentElement.className += ' ' + targetClass + '-pending';
                logRenderEvent('HTML_CLASS_SET', { className: targetClass + '-pending' });
                
                // bodyê°€ ìƒì„±ë˜ëŠ” ì¦‰ì‹œ í´ë˜ìŠ¤ ì´ë™
                const observer = new MutationObserver(function(mutations) {
                    if (document.body) {
                        document.body.className = targetClass;
                        document.documentElement.className = document.documentElement.className.replace(targetClass + '-pending', '');
                        logRenderEvent('BODY_CLASS_SET_IMMEDIATE', { className: targetClass });
                        observer.disconnect();
                    }
                });
                observer.observe(document.documentElement, { childList: true });
            } else {
                document.body.className = targetClass;
                logRenderEvent('BODY_CLASS_SET_IMMEDIATE', { className: targetClass });
            }
            
            // DOM ë¡œë“œ í›„ ì¶”ê°€ í™•ì¸
            document.addEventListener('DOMContentLoaded', function() {
                logRenderEvent('DOM_CONTENT_LOADED_START');
                
                // í´ë˜ìŠ¤ê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
                if (document.body.className !== targetClass) {
                    document.body.className = targetClass;
                    logRenderEvent('BODY_CLASS_CORRECTED', { 
                        expectedClass: targetClass,
                        actualClass: document.body.className 
                    });
                }
                
                // UI ìš”ì†Œ ìƒíƒœ ì¦‰ì‹œ í™•ì¸
                setTimeout(() => {
                    const userProfile = document.getElementById('user-profile');
                    const authButtons = document.getElementById('auth-buttons');
                    const notificationIcon = document.getElementById('notification-icon');
                    
                    logRenderEvent('UI_ELEMENTS_CHECK', {
                        userProfile: userProfile ? {
                            display: getComputedStyle(userProfile).display,
                            visibility: getComputedStyle(userProfile).visibility
                        } : 'not found',
                        authButtons: authButtons ? {
                            display: getComputedStyle(authButtons).display,
                            visibility: getComputedStyle(authButtons).visibility
                        } : 'not found',
                        notificationIcon: notificationIcon ? {
                            display: getComputedStyle(notificationIcon).display,
                            visibility: getComputedStyle(notificationIcon).visibility
                        } : 'not found'
                    });
                }, 10);
                
                // ì¶”ê°€ ì²´í¬ (CSS ë¡œë”© ì™„ë£Œ í›„)
                setTimeout(() => {
                    const userProfile = document.getElementById('user-profile');
                    const authButtons = document.getElementById('auth-buttons');
                    const notificationIcon = document.getElementById('notification-icon');
                    
                    logRenderEvent('UI_ELEMENTS_DELAYED_CHECK', {
                        userProfile: userProfile ? {
                            display: getComputedStyle(userProfile).display,
                            visibility: getComputedStyle(userProfile).visibility,
                            cssRules: Array.from(document.styleSheets).flatMap(sheet => {
                                try {
                                    return Array.from(sheet.cssRules || [])
                                        .filter(rule => rule.selectorText && rule.selectorText.includes('#user-profile'))
                                        .map(rule => ({ selector: rule.selectorText, style: rule.style.display }));
                                } catch (e) { return []; }
                            })
                        } : 'not found',
                        authButtons: authButtons ? {
                            display: getComputedStyle(authButtons).display,
                            visibility: getComputedStyle(authButtons).visibility
                        } : 'not found'
                    });
                }, 200);
            });
        })();
        
        logRenderEvent('HEAD_SCRIPT_END');
        console.log('ğŸ” TEST 2: Layout script loaded: auth and fcmDebug objects initialized');
    </script>
</head>

<body>
<header class="header" th:fragment="header">
    <div class="container">
        <div class="header-content">
            <a href="/" class="logo">
                <i class="fas fa-home"></i><span>StaySwap</span>
            </a>

            <nav class="main-nav">
                <a href="/page/listings" class="nav-link">ìˆ™ì†Œ ì°¾ê¸°</a>
                <a href="/page/new"       class="nav-link">ìˆ™ì†Œ ë“±ë¡</a>
                <a href="/page/exchanges" class="nav-link">êµí™˜ ê´€ë¦¬</a>
            </nav>

            <div class="user-actions">
                <!-- í”„ë¡œí•„ / ë“œë¡­ë‹¤ìš´ -->
                <div id="user-profile" class="user-profile-container">
                    <div class="profile-dropdown-container">
                        <a href="#" class="avatar-link" id="profile-dropdown-toggle">
                            <div class="avatar">
                                <img id="profile-image" src="/images/profile.png" alt="í”„ë¡œí•„" />
                            </div>
                        </a>

                        <div id="profile-dropdown" class="profile-dropdown">
                            <a href="/page/profile" class="dropdown-item">ë§ˆì´í˜ì´ì§€</a>
                            <a href="/page/subscription" class="dropdown-item">êµ¬ë…ê´€ë¦¬</a>
                            <a href="#" id="logout-btn" class="dropdown-item">ë¡œê·¸ì•„ì›ƒ</a>
                        </div>
                    </div>
                </div>
                
                <!-- ì•Œë¦¼ ì•„ì´ì½˜ -->
                <div id="notification-icon" class="notification-container">
                    <a href="#" id="notification-dropdown-toggle" class="notification-icon-link">
                        <i class="fas fa-bell"></i>
                        <span id="notification-badge" class="notification-badge dot-only" style="display:none;"></span>
                    </a>

                    <div id="notification-dropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <span>ì•Œë¦¼</span>
                        </div>
                        <div class="notification-list">
                            <!-- ì•Œë¦¼ ëª©ë¡ì´ JavaScriptë¡œ ë™ì  ë¡œë“œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>
                </div>

                <!-- ë¡œê·¸ì¸ ë²„íŠ¼ -->
                <div id="auth-buttons">
                    <a href="/page/auth" class="btn btn-outline">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </div>
</header>

<main><!-- í˜ì´ì§€ë³„ ë‚´ìš© --></main>

<!-- ğŸ” ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë¡œê·¸ 2 -->
<script>
    console.log('ğŸ” TEST 3: BODY ì‹œì‘ ë¶€ë¶„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ë¨');
</script>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>

<!-- ğŸ” jQuery ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 4: jQuery ë¡œë“œ í›„, jQuery ë²„ì „:', $ ? $.fn.jquery : 'jQuery ì—†ìŒ');
</script>

<!-- Firebase ì„¤ì • -->
<script th:inline="javascript">
    console.log('ğŸ” TEST 5: Firebase ì„¤ì • ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹œì‘');
    try {
        const firebaseConfig = {
            apiKey:          /*[[${firebaseConfig.apiKey}]]*/ '',
            authDomain:      /*[[${firebaseConfig.authDomain}]]*/ '',
            projectId:       /*[[${firebaseConfig.projectId}]]*/ '',
            storageBucket:   /*[[${firebaseConfig.storageBucket}]]*/ '',
            messagingSenderId: /*[[${firebaseConfig.messagingSenderId}]]*/ '',
            appId:           /*[[${firebaseConfig.appId}]]*/ '',
            measurementId:   /*[[${firebaseConfig.measurementId}]]*/ ''
        };
        
        console.log('ğŸ” TEST 6: Firebase ì„¤ì • ê°ì²´ ìƒì„±ë¨:', firebaseConfig);
        
        // ì„¤ì • ê°’ ê²€ì¦
        const missingValues = Object.entries(firebaseConfig)
            .filter(([key, value]) => !value || value === '')
            .map(([key]) => key);
        
        if (missingValues.length > 0) {
            console.error('âš ï¸ Firebase ì„¤ì •ì— ë¹ˆ ê°’ì´ ìˆìŠµë‹ˆë‹¤:', missingValues.join(', '));
            window.fcmDebug.errors.push('Firebase ì„¤ì •ì— ë¹ˆ ê°’ ìˆìŒ: ' + missingValues.join(', '));
        } else {
            console.log('âœ… Firebase ì„¤ì • ê°’ í™•ì¸ë¨');
        }
        
        // Firebase ì´ˆê¸°í™”
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            window.vapidKey = /*[[${firebaseConfig.vapidKey}]]*/ '';
            window.fcmDebug.firebaseInitialized = true;
            console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
            console.error('âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            window.fcmDebug.errors.push('Firebase SDK ë¡œë“œë˜ì§€ ì•ŠìŒ');
        }
    } catch (error) {
        console.error('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        window.fcmDebug.errors.push('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ' + error.message);
    }
</script>

<!-- ğŸ” ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 7: ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ ì „');
</script>

<!-- Auth ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ (ëª¨ë“  í˜ì´ì§€ì—ì„œ í•„ìš”) -->
<script th:src="@{/js/auth-common.js}"></script>
<script th:src="@{/js/main.js}"></script>

<!-- ğŸ” ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í›„ í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 8: ì™¸ë¶€ JS íŒŒì¼ ë¡œë“œ í›„');
    console.log('ğŸ” window.auth ìƒíƒœ:', window.auth);
    console.log('ğŸ” window.isLoggedIn í•¨ìˆ˜ ì¡´ì¬:', typeof window.isLoggedIn);
</script>

<!-- í—¤ë” UI ì œì–´ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
<script>
    console.log('ğŸ” TEST 9: Layout í—¤ë” UI ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
    
    // í—¤ë” UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤ (ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€)
    if (!window.headerUIInitialized) {
        window.headerUIInitialized = true;
        console.log('ğŸ” TEST 10: í—¤ë” UI ì´ˆê¸°í™” ì‹œì‘');

        /* â‘  ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒì— ë”°ë¼ ë²„íŠ¼ë§Œ í† ê¸€ */
        window.toggleHeaderUI = function(isLoggedIn) {
            console.log('ğŸ” toggleHeaderUI í˜¸ì¶œ:', isLoggedIn);
            const userProfile = document.getElementById('user-profile');
            const authButtons = document.getElementById('auth-buttons');
            const notificationIcon = document.getElementById('notification-icon');
            
            if (isLoggedIn) {
                console.log('ğŸ” ë¡œê·¸ì¸ UI í‘œì‹œ');
                if (userProfile) {
                    userProfile.style.display = 'block';
                    console.log('ğŸ” user-profile í‘œì‹œë¨');
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'block';
                    console.log('ğŸ” notification-icon í‘œì‹œë¨');
                }
                if (authButtons) {
                    authButtons.style.display = 'none';
                    console.log('ğŸ” auth-buttons ìˆ¨ê¹€');
                }
            } else {
                console.log('ğŸ” ë¡œê·¸ì•„ì›ƒ UI í‘œì‹œ');
                if (userProfile) {
                    userProfile.style.display = 'none';
                    console.log('ğŸ” user-profile ìˆ¨ê¹€');
                }
                if (notificationIcon) {
                    notificationIcon.style.display = 'none';
                    console.log('ğŸ” notification-icon ìˆ¨ê¹€');
                }
                if (authButtons) {
                    authButtons.style.display = 'flex';
                    console.log('ğŸ” auth-buttons í‘œì‹œë¨');
                }
            }
        };

        /* â‘¡ ì•„ë°”íƒ€ ì´ë¯¸ì§€Â·ì´ë‹ˆì…œ ì„¸íŒ… */
        window.fillProfile = function(user) {
            console.log('ğŸ” fillProfile í˜¸ì¶œ:', user);
            if (!user) return;
            
            const img = document.getElementById('profile-image');
            const init = document.getElementById('profile-initial');
            const userProfile = document.getElementById('user-profile');

            // í”„ë¡œí•„ ì»¨í…Œì´ë„ˆì— ë¡œë”© í´ë˜ìŠ¤ ì¶”ê°€
            if (userProfile) {
                userProfile.classList.add('loading');
            }

            if (user.profile && user.profile !== '/images/profile.png') {
                // ìƒˆ ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ
                const newImg = new Image();
                newImg.onload = function() {
                    if (img) {
                        // ë¶€ë“œëŸ¬ìš´ ì „í™˜ì„ ìœ„í•´ opacity ì¡°ì‘
                        img.style.opacity = '0.7';
                        setTimeout(() => {
                            img.src = user.profile;
                            img.style.display = 'block';
                            img.style.opacity = '1';
                            console.log('ğŸ” í”„ë¡œí•„ ì´ë¯¸ì§€ ë¶€ë“œëŸ½ê²Œ ì„¤ì •ë¨');
                        }, 100);
                    }
                    if (init) init.style.display = 'none';
                    
                    // ë¡œë”© ìƒíƒœ ì œê±°
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.onerror = function() {
                    console.warn('ğŸ” í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ì´ë¯¸ì§€ ì‚¬ìš©');
                    // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                    if (userProfile) {
                        userProfile.classList.remove('loading');
                    }
                };
                newImg.src = user.profile;
            } else {
                // í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ ê¸°ë³¸ ì´ë¯¸ì§€ì¸ ê²½ìš°
                if (img) {
                    img.style.display = 'block'; // ê¸°ë³¸ ì´ë¯¸ì§€ ìœ ì§€
                    console.log('ğŸ” ê¸°ë³¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ìœ ì§€ë¨');
                }
                if (init && user.name) {
                    init.style.display = 'block';
                    init.textContent = user.name.charAt(0);
                    console.log('ğŸ” í”„ë¡œí•„ ì´ë‹ˆì…œ ì„¤ì •ë¨');
                }
                
                // ë¡œë”© ìƒíƒœ ì œê±°
                if (userProfile) {
                    userProfile.classList.remove('loading');
                }
            }
        };

        /* â‘¢ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ */
        window.fetchUserInfo = async function() {
            console.log('ğŸ” fetchUserInfo í˜¸ì¶œ');
            
            // ì¸ì¦ ìƒíƒœëŠ” auth-common.jsì—ì„œ ê´€ë¦¬
            const isUserLoggedIn = (typeof window.isLoggedIn === 'function') 
                ? window.isLoggedIn() 
                : (!!window.auth?.accessToken);
            
            console.log('ğŸ” ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸:', isUserLoggedIn);
            
            if (isUserLoggedIn) {
                window.toggleHeaderUI(true);
                try {
                    console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ API í˜¸ì¶œ ì‹œë„');
                    // fetchWithAuth í•¨ìˆ˜ ì‚¬ìš© (auth-common.jsì—ì„œ ì œê³µ)
                    const r = (typeof window.fetchWithAuth === 'function')
                        ? await window.fetchWithAuth('/api/user/me')
                        : await fetch('/api/user/me', {
                              headers: { Authorization: `Bearer ${window.auth.accessToken}` },
                              credentials: 'include'
                          });
                    
                    if (r && r.ok) {
                        const userData = await r.json();
                        console.log('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì„±ê³µ:', userData);
                        window.fillProfile(userData.data || userData);
                    } else {
                        console.warn('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨ - API ì‘ë‹µ ì˜¤ë¥˜');
                    }
                } catch (error) { 
                    console.warn('ğŸ” ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                }
                return;
            }
            window.toggleHeaderUI(false);
        };

        /* â‘£ auth ìƒíƒœ ì´ë²¤íŠ¸ â†’ í—¤ë” ë™ê¸°í™” */
        document.addEventListener('authStateChanged', function(e) {
            console.log('ğŸ” Layoutì—ì„œ authStateChanged ì´ë²¤íŠ¸ ìˆ˜ì‹ :', e.detail.isLoggedIn);
            if (e.detail.isLoggedIn) {
                window.fetchUserInfo();
            } else {
                window.toggleHeaderUI(false);
            }
        });

        /* â‘¤ í˜ì´ì§€ ë¡œë“œ ì‹œ í—¤ë” ë™ê¸°í™” */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” TEST 11: Layout DOMContentLoaded - í—¤ë” ë™ê¸°í™” ì‹œì‘');
            // auth-common.js ë¡œë“œ ëŒ€ê¸° í›„ ì‹¤í–‰
            setTimeout(() => {
                console.log('ğŸ” TEST 12: ì§€ì—° í›„ fetchUserInfo í˜¸ì¶œ');
                window.fetchUserInfo();
            }, 200); // 200msë¡œ ì¦ê°€
        });

        // ì¶”ê°€: í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ì—ë„ í•œë²ˆ ë” ì²´í¬ (ë°±ì—…)
        window.addEventListener('load', function() {
            console.log('ğŸ” TEST 13: Window load ì™„ë£Œ - ì¶”ê°€ ì²´í¬');
            setTimeout(() => {
                // auth ìƒíƒœê°€ ì„¤ì •ë˜ì—ˆì§€ë§Œ UIê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„
                if (window.auth?.accessToken && 
                    document.getElementById('user-profile')?.style.display === 'none') {
                    console.log('ğŸ” í† í°ì€ ìˆì§€ë§Œ UIê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ - ê°•ì œ ì—…ë°ì´íŠ¸');
                    window.fetchUserInfo();
                }
            }, 300);
        });
    } else {
        console.log('ğŸ” TEST 10-1: í—¤ë” UI ì´ë¯¸ ì´ˆê¸°í™”ë¨');
    }
</script>

<!-- ğŸ” ìµœì¢… í…ŒìŠ¤íŠ¸ -->
<script>
    console.log('ğŸ” TEST 14: Layout ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');
</script>

</body>
</html>
