<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM 디버깅 페이지</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .status {
            font-weight: bold;
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .logs {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 10px;
        }
        button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        h1 {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FCM 디버깅 페이지</h1>
        
        <div class="card">
            <h2>Firebase 초기화 상태</h2>
            <p class="status" id="firebase-status">확인 중...</p>
            <button id="init-firebase">Firebase 초기화</button>
        </div>
        
        <div class="card">
            <h2>서비스 워커 등록 상태</h2>
            <p class="status" id="sw-status">확인 중...</p>
            <button id="register-sw">서비스 워커 등록</button>
        </div>
        
        <div class="card">
            <h2>알림 권한 상태</h2>
            <p class="status" id="permission-status">확인 중...</p>
            <button id="request-permission">권한 요청</button>
        </div>
        
        <div class="card">
            <h2>FCM 토큰 상태</h2>
            <p class="status" id="token-status">확인 중...</p>
            <div id="token-value" style="word-break: break-all; margin-top: 10px; font-size: 12px;"></div>
            <button id="get-token">토큰 가져오기</button>
        </div>
        
        <div class="card">
            <h2>서버 등록 상태</h2>
            <p class="status" id="server-status">확인 중...</p>
            <button id="register-token">서버에 토큰 등록</button>
        </div>
        
        <div class="card">
            <h2>인증 상태</h2>
            <p class="status" id="auth-status">확인 중...</p>
            <div id="auth-details" style="margin-top: 10px; font-size: 14px;"></div>
        </div>
        
        <div class="card">
            <h2>로그</h2>
            <div class="logs" id="logs"></div>
            <button id="clear-logs">로그 지우기</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging-compat.js"></script>
    
    <script>
        // 디버그 로그 함수
        function log(message, type = 'info') {
            const logsElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsElement.appendChild(logEntry);
            logsElement.scrollTop = logsElement.scrollHeight;
            console.log(`[FCM Debug] ${message}`);
        }
        
        // Firebase 초기화 함수
        async function initializeFirebase() {
            try {
                const statusElement = document.getElementById('firebase-status');
                statusElement.textContent = "Firebase 설정 로드 중...";
                
                // API에서 Firebase 설정 가져오기
                const response = await fetch('/api/config/firebase');
                if (!response.ok) {
                    throw new Error(`Firebase 설정 로드 실패: ${response.status}`);
                }
                
                const firebaseConfig = await response.json();
                log(`Firebase 설정 로드 성공: ${JSON.stringify(firebaseConfig)}`);
                
                // 이미 초기화되었는지 확인
                if (firebase.apps.length > 0) {
                    log('Firebase가 이미 초기화되어 있습니다.');
                    statusElement.textContent = "초기화됨 (이미 완료)";
                    statusElement.className = "status success";
                    return firebase;
                }
                
                // Firebase 초기화
                firebase.initializeApp(firebaseConfig);
                window.vapidKey = firebaseConfig.vapidKey;
                
                log('Firebase 초기화 성공');
                statusElement.textContent = "초기화됨 (성공)";
                statusElement.className = "status success";
                return firebase;
            } catch (error) {
                log(`Firebase 초기화 실패: ${error.message}`, 'error');
                document.getElementById('firebase-status').textContent = `초기화 실패: ${error.message}`;
                document.getElementById('firebase-status').className = "status error";
                throw error;
            }
        }
        
        // 서비스 워커 등록 함수
        async function registerServiceWorker() {
            try {
                const statusElement = document.getElementById('sw-status');
                statusElement.textContent = "서비스 워커 등록 중...";
                
                if (!('serviceWorker' in navigator)) {
                    throw new Error('이 브라우저는 서비스 워커를 지원하지 않습니다.');
                }
                
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                log(`서비스 워커 등록 성공: ${registration.scope}`);
                statusElement.textContent = `등록됨: ${registration.scope}`;
                statusElement.className = "status success";
                return registration;
            } catch (error) {
                log(`서비스 워커 등록 실패: ${error.message}`, 'error');
                document.getElementById('sw-status').textContent = `등록 실패: ${error.message}`;
                document.getElementById('sw-status').className = "status error";
                throw error;
            }
        }
        
        // 알림 권한 요청 함수
        async function requestNotificationPermission() {
            try {
                const statusElement = document.getElementById('permission-status');
                statusElement.textContent = "권한 요청 중...";
                
                const permission = await Notification.requestPermission();
                log(`알림 권한 상태: ${permission}`);
                
                if (permission === 'granted') {
                    statusElement.textContent = "권한 허용됨";
                    statusElement.className = "status success";
                } else if (permission === 'denied') {
                    statusElement.textContent = "권한 거부됨";
                    statusElement.className = "status error";
                } else {
                    statusElement.textContent = "권한 응답 없음";
                    statusElement.className = "status warning";
                }
                
                return permission;
            } catch (error) {
                log(`알림 권한 요청 실패: ${error.message}`, 'error');
                document.getElementById('permission-status').textContent = `요청 실패: ${error.message}`;
                document.getElementById('permission-status').className = "status error";
                throw error;
            }
        }
        
        // FCM 토큰 가져오기 함수
        async function getFCMToken() {
            try {
                const statusElement = document.getElementById('token-status');
                const tokenElement = document.getElementById('token-value');
                
                statusElement.textContent = "토큰 요청 중...";
                tokenElement.textContent = "";
                
                // Firebase가 초기화되었는지 확인
                if (firebase.apps.length === 0) {
                    await initializeFirebase();
                }
                
                // 서비스 워커가 등록되었는지 확인
                const swRegistration = await navigator.serviceWorker.getRegistration('/firebase-messaging-sw.js');
                if (!swRegistration) {
                    await registerServiceWorker();
                }
                
                // 알림 권한 확인
                if (Notification.permission !== 'granted') {
                    const permission = await requestNotificationPermission();
                    if (permission !== 'granted') {
                        throw new Error('알림 권한이 허용되지 않았습니다.');
                    }
                }
                
                // 메시징 인스턴스 가져오기
                const messaging = firebase.messaging();
                
                // 토큰 요청
                const token = await messaging.getToken({
                    vapidKey: window.vapidKey
                });
                
                if (token) {
                    log(`FCM 토큰 획득 성공: ${token}`);
                    statusElement.textContent = "토큰 획득 성공";
                    statusElement.className = "status success";
                    tokenElement.textContent = token;
                    return token;
                } else {
                    throw new Error('토큰을 가져올 수 없습니다.');
                }
            } catch (error) {
                log(`FCM 토큰 요청 실패: ${error.message}`, 'error');
                document.getElementById('token-status').textContent = `토큰 요청 실패: ${error.message}`;
                document.getElementById('token-status').className = "status error";
                throw error;
            }
        }
        
        // 서버에 토큰 등록 함수
        async function registerTokenToServer() {
            try {
                const statusElement = document.getElementById('server-status');
                statusElement.textContent = "서버 등록 중...";
                
                // 인증 상태 확인
                if (!isUserLoggedIn()) {
                    throw new Error('로그인되지 않은 상태입니다.');
                }
                
                // 토큰 가져오기
                const token = await getFCMToken();
                
                // 기기 정보 수집
                const deviceInfo = {
                    deviceId: generateDeviceId(),
                    deviceType: 'WEB',
                    fcmToken: token,
                    deviceName: navigator.userAgent
                };
                
                log(`서버에 등록할 디바이스 정보: ${JSON.stringify(deviceInfo)}`);
                
                // 서버 API 호출
                const response = await fetch('/api/users/devices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: JSON.stringify(deviceInfo)
                });
                
                if (response.ok) {
                    log('FCM 토큰 서버 등록 성공');
                    statusElement.textContent = "서버 등록 성공";
                    statusElement.className = "status success";
                    return true;
                } else {
                    const errorText = await response.text();
                    throw new Error(`서버 응답 오류 (${response.status}): ${errorText}`);
                }
            } catch (error) {
                log(`서버 등록 실패: ${error.message}`, 'error');
                document.getElementById('server-status').textContent = `서버 등록 실패: ${error.message}`;
                document.getElementById('server-status').className = "status error";
                throw error;
            }
        }
        
        // 기기 ID 생성
        function generateDeviceId() {
            let deviceId = localStorage.getItem('device_id');
            if (!deviceId) {
                deviceId = 'web_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('device_id', deviceId);
            }
            return deviceId;
        }
        
        // 사용자 로그인 상태 확인
        function isUserLoggedIn() {
            // window.auth 객체를 통해 로그인 상태 확인
            if (window.auth && window.auth.accessToken) {
                return true;
            }
            
            // 기존 방식도 유지 (하위 호환성)
            return !!getAuthToken();
        }
        
        // 인증 토큰 가져오기
        function getAuthToken() {
            // 1. 메모리에 저장된 인증 토큰 우선 사용
            if (window.auth && window.auth.accessToken) {
                return window.auth.accessToken;
            }
            
            // 2. 로컬/세션 스토리지 확인 (하위 호환성)
            return localStorage.getItem('accessToken') || 
                   sessionStorage.getItem('auth_token') || 
                   '';
        }
        
        // 인증 상태 확인 함수
        function checkAuthStatus() {
            const statusElement = document.getElementById('auth-status');
            const detailsElement = document.getElementById('auth-details');
            
            const token = getAuthToken();
            const isLoggedIn = isUserLoggedIn();
            
            if (isLoggedIn) {
                statusElement.textContent = "로그인됨";
                statusElement.className = "status success";
                
                // 토큰 정보 표시
                let authDetails = '';
                if (window.auth) {
                    authDetails += `<strong>메모리 토큰:</strong> ${window.auth.accessToken ? '있음' : '없음'}<br>`;
                    authDetails += `<strong>토큰 만료:</strong> ${window.auth.tokenExpireTime ? new Date(window.auth.tokenExpireTime).toLocaleString() : '정보 없음'}<br>`;
                    authDetails += `<strong>초기화 상태:</strong> ${window.auth.isInitialized ? '완료' : '미완료'}<br>`;
                }
                
                authDetails += `<strong>로컬 스토리지 토큰:</strong> ${localStorage.getItem('accessToken') ? '있음' : '없음'}<br>`;
                authDetails += `<strong>세션 스토리지 토큰:</strong> ${sessionStorage.getItem('auth_token') ? '있음' : '없음'}<br>`;
                
                detailsElement.innerHTML = authDetails;
                log('사용자가 로그인 상태입니다.');
            } else {
                statusElement.textContent = "로그인되지 않음";
                statusElement.className = "status error";
                detailsElement.innerHTML = "인증 정보가 없습니다. 로그인이 필요합니다.";
                log('사용자가 로그인되지 않았습니다.', 'warning');
            }
        }
        
        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            // 상태 확인
            try {
                // 알림 API 지원 확인
                if (!('Notification' in window)) {
                    log('이 브라우저는 알림을 지원하지 않습니다.', 'error');
                    document.getElementById('permission-status').textContent = "브라우저가 알림을 지원하지 않음";
                    document.getElementById('permission-status').className = "status error";
                } else {
                    // 현재 알림 권한 상태 표시
                    const permission = Notification.permission;
                    let statusText, statusClass;
                    
                    if (permission === 'granted') {
                        statusText = "권한 허용됨";
                        statusClass = "success";
                    } else if (permission === 'denied') {
                        statusText = "권한 거부됨";
                        statusClass = "error";
                    } else {
                        statusText = "권한 응답 없음";
                        statusClass = "warning";
                    }
                    
                    document.getElementById('permission-status').textContent = statusText;
                    document.getElementById('permission-status').className = `status ${statusClass}`;
                    log(`현재 알림 권한 상태: ${permission}`);
                }
                
                // Firebase 앱 상태 확인
                if (firebase.apps.length > 0) {
                    document.getElementById('firebase-status').textContent = "초기화됨";
                    document.getElementById('firebase-status').className = "status success";
                    log('Firebase가 이미 초기화되어 있습니다.');
                } else {
                    document.getElementById('firebase-status').textContent = "초기화되지 않음";
                    document.getElementById('firebase-status').className = "status warning";
                    log('Firebase가 초기화되지 않았습니다.', 'warning');
                }
                
                // 서비스 워커 상태 확인
                navigator.serviceWorker.getRegistration('/firebase-messaging-sw.js').then(registration => {
                    if (registration) {
                        document.getElementById('sw-status').textContent = `등록됨: ${registration.scope}`;
                        document.getElementById('sw-status').className = "status success";
                        log(`서비스 워커가 등록되어 있습니다: ${registration.scope}`);
                    } else {
                        document.getElementById('sw-status').textContent = "등록되지 않음";
                        document.getElementById('sw-status').className = "status warning";
                        log('서비스 워커가 등록되지 않았습니다.', 'warning');
                    }
                }).catch(error => {
                    document.getElementById('sw-status').textContent = `확인 실패: ${error.message}`;
                    document.getElementById('sw-status').className = "status error";
                    log(`서비스 워커 상태 확인 실패: ${error.message}`, 'error');
                });
                
                // 인증 상태 확인
                checkAuthStatus();
                
                // FCM 토큰 상태 초기화
                document.getElementById('token-status').textContent = "확인되지 않음";
                document.getElementById('token-status').className = "status warning";
                
                // 서버 등록 상태 초기화
                document.getElementById('server-status').textContent = "확인되지 않음";
                document.getElementById('server-status').className = "status warning";
                
            } catch (error) {
                log(`초기 상태 확인 중 오류 발생: ${error.message}`, 'error');
            }
            
            // 버튼 이벤트 리스너 등록
            document.getElementById('init-firebase').addEventListener('click', () => {
                initializeFirebase().catch(error => {
                    log(`Firebase 초기화 버튼 클릭 후 오류: ${error.message}`, 'error');
                });
            });
            
            document.getElementById('register-sw').addEventListener('click', () => {
                registerServiceWorker().catch(error => {
                    log(`서비스 워커 등록 버튼 클릭 후 오류: ${error.message}`, 'error');
                });
            });
            
            document.getElementById('request-permission').addEventListener('click', () => {
                requestNotificationPermission().catch(error => {
                    log(`권한 요청 버튼 클릭 후 오류: ${error.message}`, 'error');
                });
            });
            
            document.getElementById('get-token').addEventListener('click', () => {
                getFCMToken().catch(error => {
                    log(`토큰 요청 버튼 클릭 후 오류: ${error.message}`, 'error');
                });
            });
            
            document.getElementById('register-token').addEventListener('click', () => {
                registerTokenToServer().catch(error => {
                    log(`서버 등록 버튼 클릭 후 오류: ${error.message}`, 'error');
                });
            });
            
            document.getElementById('clear-logs').addEventListener('click', () => {
                document.getElementById('logs').innerHTML = '';
                log('로그가 지워졌습니다.');
            });
        });
    </script>
</body>
</html> 